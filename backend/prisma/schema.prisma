// Prisma Schema for MOVZZ Backend
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id                String            @id @default(uuid())
  phone             String            @unique
  email             String?           @unique
  name              String?
  profileImage      String?
  isVerified        Boolean           @default(false)
  preferredLanguage String            @default("en")
  preferredPayment  String            @default("cash")
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  lastLoginAt       DateTime?
  
  // Relations
  otpCodes          OTPCode[]
  bookings          Booking[]
  savedLocations    SavedLocation[]
  paymentMethods    PaymentMethod[]

  @@index([phone])
  @@index([email])
  @@map("users")
}

model OTPCode {
  id        String   @id @default(uuid())
  userId    String
  phone     String
  code      String
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone, code])
  @@index([expiresAt])
  @@map("otp_codes")
}

model SavedLocation {
  id        String   @id @default(uuid())
  userId    String
  label     String   // "Home", "Work", "Gym", etc.
  address   String
  latitude  Float
  longitude Float
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("saved_locations")
}

// ============================================
// BOOKING MANAGEMENT
// ============================================

model Booking {
  id                  String        @id @default(uuid())
  userId              String
  
  // Location details
  pickupAddress       String
  pickupLat           Float
  pickupLng           Float
  dropAddress         String
  dropLat             Float
  dropLng             Float
  distance            Float         // in kilometers
  
  // Provider details
  provider            String        // "uber", "ola", "rapido"
  vehicleType         String        // "cab", "bike", "auto"
  rideType            String?       // "UberGo", "Ola Mini", etc.
  
  // Pricing
  estimatedPrice      Float
  finalPrice          Float?
  currency            String        @default("INR")
  
  // Driver details (populated when assigned)
  driverName          String?
  driverPhone         String?
  driverRating        Float?
  vehicleNumber       String?
  vehicleModel        String?
  
  // Status tracking
  status              BookingStatus @default(PENDING)
  paymentMethod       String        @default("cash")
  paymentStatus       PaymentStatus @default(PENDING)
  transactionId       String?
  
  // Timing
  estimatedETA        Int?          // in seconds
  scheduledAt         DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  cancelledAt         DateTime?
  cancellationReason  String?
  
  // Metadata
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  // Relations
  user                User          @relation(fields: [userId], references: [id])
  legs                BookingLeg[]

  @@index([userId])
  @@index([status])
  @@index([provider])
  @@index([createdAt])
  @@map("bookings")
}

model BookingLeg {
  id              String   @id @default(uuid())
  bookingId       String
  sequence        Int      // Order of this leg in multi-modal journey
  
  // Leg details
  provider        String
  vehicleType     String
  fromAddress     String
  fromLat         Float
  fromLng         Float
  toAddress       String
  toLat           Float
  toLng           Float
  distance        Float
  
  // Pricing
  estimatedPrice  Float
  finalPrice      Float?
  
  // Timing
  estimatedTime   Int      // in seconds
  startedAt       DateTime?
  completedAt     DateTime?
  
  createdAt       DateTime @default(now())
  
  // Relations
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@map("booking_legs")
}

// ============================================
// PROVIDER MANAGEMENT
// ============================================

model ProviderCache {
  id                String   @id @default(uuid())
  provider          String   // "uber", "ola", "rapido"
  routeHash         String   // Hash of pickup/drop coordinates
  vehicleType       String
  
  // Cached data
  estimatedPrice    Float
  estimatedETA      Int      // in seconds
  availability      Boolean
  surgeMultiplier   Float    @default(1.0)
  rawResponse       Json?    // Store full API response
  
  // Cache metadata
  expiresAt         DateTime
  createdAt         DateTime @default(now())

  @@unique([provider, routeHash, vehicleType])
  @@index([expiresAt])
  @@map("provider_cache")
}

model ProviderLog {
  id            String   @id @default(uuid())
  provider      String
  endpoint      String
  method        String
  requestData   Json?
  responseData  Json?
  statusCode    Int?
  success       Boolean
  errorMessage  String?
  responseTime  Int?     // in milliseconds
  createdAt     DateTime @default(now())

  @@index([provider])
  @@index([createdAt])
  @@index([success])
  @@map("provider_logs")
}

// ============================================
// PAYMENT MANAGEMENT
// ============================================

model PaymentMethod {
  id            String   @id @default(uuid())
  userId        String
  type          String   // "card", "upi", "wallet"
  provider      String   // "razorpay", "paytm", etc.
  
  // Card details (encrypted)
  last4         String?
  cardBrand     String?
  expiryMonth   Int?
  expiryYear    Int?
  
  // UPI details
  upiId         String?
  
  // Wallet details
  walletId      String?
  
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("payment_methods")
}

// ============================================
// ANALYTICS & METRICS
// ============================================

model RouteAnalytics {
  id                String   @id @default(uuid())
  routeHash         String   // Hash of pickup/drop coordinates
  
  // Route details
  pickupLat         Float
  pickupLng         Float
  dropLat           Float
  dropLng           Float
  distance          Float
  
  // Aggregated data
  totalBookings     Int      @default(0)
  avgPrice          Float?
  avgDuration       Int?     // in seconds
  popularProvider   String?
  popularVehicle    String?
  
  // Time-based analytics
  peakHours         Json?    // Array of peak hours
  avgWaitTime       Int?     // in seconds
  
  lastUpdated       DateTime @updatedAt
  createdAt         DateTime @default(now())

  @@unique([routeHash])
  @@index([totalBookings])
  @@map("route_analytics")
}

model SystemMetrics {
  id                String   @id @default(uuid())
  metricType        String   // "api_calls", "bookings", "revenue", etc.
  metricValue       Float
  metadata          Json?
  timestamp         DateTime @default(now())

  @@index([metricType])
  @@index([timestamp])
  @@map("system_metrics")
}

// ============================================
// ENUMS
// ============================================

enum BookingStatus {
  PENDING           // Booking created, waiting for confirmation
  SEARCHING         // Looking for driver
  DRIVER_ASSIGNED   // Driver found and assigned
  DRIVER_ARRIVED    // Driver reached pickup location
  IN_PROGRESS       // Trip started
  COMPLETED         // Trip completed successfully
  CANCELLED         // Booking cancelled
  FAILED            // Booking failed
  EXPIRED           // Booking expired (no driver found)
}

enum PaymentStatus {
  PENDING           // Payment not initiated
  PROCESSING        // Payment in progress
  COMPLETED         // Payment successful
  FAILED            // Payment failed
  REFUNDED          // Payment refunded
}
